generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String          @id @default(uuid())
  email                   String          @unique
  passwordHash            String
  name                    String
  role                    UserRole
  isApproved              Boolean         @default(false)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  resetToken              String?         @unique
  resetTokenExpiry        DateTime?
  recoveryEmail           String?
  invitationCodeId        String?
  verificationToken       String?         @unique
  verificationTokenExpiry DateTime?
  isVerified              Boolean         @default(false)
  lastLogin               DateTime?
  chatSessions            ChatSession[]
  documents               Document[]
  feedback                Feedback[]
  knowledgeNotes          KnowledgeNote[]
  messages                Message[]
  quickAccessLinks        QuickAccessLink[]         @relation("QuickAccessLinks")
  documentLibraryEntries  DocumentLibraryEntry[]    @relation("DocumentLibraryEntries")
  documentLibraryBatches  DocumentLibraryBatch[]    @relation("DocumentLibraryBatches")
  invitationCode          InvitationCode?           @relation(fields: [invitationCodeId], references: [id])

  @@index([email])
  @@index([role])
  @@map("users")
}

model Department {
  id             String          @id @default(uuid())
  name           String          @unique
  abbreviation   String?
  color          String?
  icon           String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  iconUrl        String?
  imageUrl       String?
  knowledgeNotes KnowledgeNote[]

  @@index([isActive])
  @@map("departments")
}

model DocumentType {
  id             String          @id @default(uuid())
  name           String          @unique
  icon           String?
  color          String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  iconUrl        String?
  imageUrl       String?
  knowledgeNotes KnowledgeNote[]

  @@index([isActive])
  @@map("document_types")
}

model KnowledgeNote {
  id              String        @id @default(uuid())
  title           String
  content         String
  departmentId    String?
  documentTypeId  String?
  category        String?
  priority        String        @default("standard")
  formatType      String        @default("auto")
  accessLevel     String[]      @default(["public", "student", "member", "chairperson"])
  status          String        @default("active")
  isActive        Boolean       @default(true)
  tags            String[]      @default([])
  createdBy       String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  creator         User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  department      Department?   @relation(fields: [departmentId], references: [id])
  documentType    DocumentType? @relation(fields: [documentTypeId], references: [id])
  linkedDocuments Document[]    @relation("KnowledgeNoteDocuments")

  @@index([isActive])
  @@index([createdBy])
  @@index([priority])
  @@index([departmentId])
  @@index([documentTypeId])
  @@map("knowledge_notes")
}

model ChatSession {
  id        String    @id @default(uuid())
  userId    String
  title     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  deletedBy String?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("chat_sessions")
}

model Message {
  id        String      @id @default(uuid())
  sessionId String
  userId    String
  role      String
  content   String
  sources   Json?
  createdAt DateTime    @default(now())
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
  @@map("messages")
}

model Document {
  id                   String          @id @default(uuid())
  filename             String
  originalName         String
  accessLevel          AccessLevel     @default(student)
  category             String          @default("policy")
  department           String          @default("General")
  filePath             String
  fileSize             Int
  status               String          @default("processing")
  uploadedById         String
  uploadedAt           DateTime        @default(now())
  processedAt          DateTime?
  vectorIds            Json?
  chunkCount           Int?
  uploadedBy           User            @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  linkedKnowledgeNotes KnowledgeNote[] @relation("KnowledgeNoteDocuments")

  @@index([accessLevel])
  @@index([status])
  @@index([uploadedById])
  @@map("documents")
}

model SystemPrompt {
  id        String   @id @default(uuid())
  name      String   @unique
  content   String
  isActive  Boolean  @default(true)
  updatedBy String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("system_prompts")
}

model SignupCode {
  id        String    @id @default(uuid())
  code      String    @unique
  isUsed    Boolean   @default(false)
  usedBy    String?
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  expiresAt DateTime?

  @@index([code])
  @@index([isUsed])
  @@map("signup_codes")
}

model InvitationCode {
  id         String    @id @default(uuid())
  code       String    @unique
  isActive   Boolean   @default(true)
  createdBy  String
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  usageCount Int       @default(0)
  remark     String?
  users      User[]

  @@index([code])
  @@index([isActive])
  @@map("invitation_codes")
}

model QuickAccessLink {
  id        String   @id @default(uuid())
  name      String
  url       String
  section   String   @default("others")
  icon      String?
  roles     String[] @default(["public", "student", "member", "chairperson"])
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  isSystem  Boolean  @default(false)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("QuickAccessLinks", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([section])
  @@index([isActive])
  @@index([order])
  @@index([createdBy])
  @@map("quick_access_links")
}

model PopularQuestion {
  id        String   @id @default(uuid())
  question  String
  roles     String[] @default(["public", "student", "member", "chairperson"])
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("popular_questions")
}

model Feedback {
  id        String   @id @default(uuid())
  content   String
  userId    String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("feedback")
}

model Version {
  id            String   @id @default(uuid())
  versionNumber String
  commitHash    String
  description   String
  isCurrent     Boolean  @default(false)
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isCurrent])
  @@index([createdAt])
  @@map("versions")
}

model ToolPermission {
  id           String   @id @default(uuid())
  toolName     String   @unique
  description  String?
  allowedRoles String[] @default(["chairperson"])
  updatedBy    String?
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@map("tool_permissions")
}

model ModelConfig {
  id          String   @id @default(uuid())
  modelName   String   @unique
  displayName String
  description String
  isActive    Boolean  @default(false)
  updatedBy   String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@map("model_configs")
}

model JcrJournalMetric {
  id               Int      @id @default(autoincrement())
  fullTitle        String   @map("full_title")
  normalizedTitle  String   @map("normalized_title")
  issnPrint        String?  @map("issn_print")
  issnElectronic   String?  @map("issn_electronic")
  category         String
  edition          String?
  jifYear          Int      @map("jif_year")
  jifValue         Decimal? @map("jif_value") @db.Decimal(10, 3)
  jifQuartile      String   @map("jif_quartile")
  jciValue         Decimal? @map("jci_value") @db.Decimal(10, 3)
  percentCitableOa Decimal? @map("percent_citable_oa") @db.Decimal(10, 2)
  source           String?  @default("JCR")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([issnPrint, jifYear])
  @@index([issnElectronic, jifYear])
  @@index([normalizedTitle, jifYear])
  @@index([normalizedTitle, jifYear, category])
  @@map("jcr_journal_metrics")
}

model NatureIndexInstitution {
  id             String   @id @default(uuid())
  position       Int
  institution    String
  normalizedName String   @map("normalized_name")
  country        String
  count          Int
  share          Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([normalizedName])
  @@index([country])
  @@index([position])
  @@map("nature_index_institutions")
}

model NatureIndexJournal {
  id             String   @id @default(uuid())
  journalName    String   @unique
  isNatureIndex  Boolean  @default(true)
  normalizedName String   @map("normalized_name")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([normalizedName])
  @@map("nature_index_journals")
}

model RCMember {
  id                String               @id @default(uuid())
  name              String
  staffId           String?
  totalPublications Int                  @default(0)
  journalArticles   Int                  @default(0)
  conferencePapers  Int                  @default(0)
  q1Publications    Int                  @default(0)
  q2Publications    Int                  @default(0)
  q3Publications    Int                  @default(0)
  q4Publications    Int                  @default(0)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  publications      Publication[]
  groupMemberships  WorkingGroupMember[]

  @@index([name])
  @@map("rc_members")
}

model Publication {
  id              String   @id @default(uuid())
  memberId        String
  title           String
  journalName     String?
  publicationType String?
  wosQuartile     String?
  authorshipRole  String?
  publicationYear Int?
  publicationDate String?
  role            String?
  issn            String?
  doi             String?
  createdAt       DateTime @default(now())
  member          RCMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([wosQuartile])
  @@index([publicationYear])
  @@index([authorshipRole])
  @@map("publications")
}

model RCPostgraduateMember {
  id                  String                    @id @default(uuid())
  name                String
  staffId             String?
  faculty             String?
  totalStudents       Int                       @default(0)
  inProgressCount     Int                       @default(0)
  completedCount      Int                       @default(0)
  phdCount            Int                       @default(0)
  masterCount         Int                       @default(0)
  mainSupervisorCount Int                       @default(0)
  coSupervisorCount   Int                       @default(0)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  supervisions        PostgraduateSupervision[]

  @@index([name])
  @@map("rc_postgraduate_members")
}

model PostgraduateSupervision {
  id             String               @id @default(uuid())
  memberId       String
  staffId        String?
  staffName      String
  faculty        String?
  staffCategory  String?
  status         String
  areaOfStudy    String?
  researchCentre String?
  studentName    String
  level          String
  institution    String?
  programTitle   String?
  startDate      String?
  completedDate  String?
  startYear      Int?
  completedYear  Int?
  role           String
  createdAt      DateTime             @default(now())
  member         RCPostgraduateMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([status])
  @@index([level])
  @@index([role])
  @@index([startYear])
  @@map("postgraduate_supervisions")
}

model WorkingGroup {
  id          String               @id @default(uuid())
  name        String
  description String?
  createdBy   String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  members     WorkingGroupMember[]

  @@index([createdBy])
  @@map("working_groups")
}

model WorkingGroupMember {
  groupId  String
  memberId String
  addedAt  DateTime     @default(now())
  group    WorkingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  member   RCMember     @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([groupId, memberId])
  @@index([groupId])
  @@index([memberId])
  @@map("working_group_members")
}

model RCGrantMember {
  id                  String    @id @default(uuid())
  name                String
  staffId             String?
  faculty             String?
  totalGrants         Int       @default(0)
  totalFunding        Decimal   @default(0) @db.Decimal(15, 2)
  inUtarGrants        Int       @default(0)
  notInUtarGrants     Int       @default(0)
  internalGrants      Int       @default(0)
  externalGrants      Int       @default(0)
  piCount             Int       @default(0)
  coResearcherCount   Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  grants              Grant[]

  @@index([name])
  @@map("rc_grant_members")
}

model Grant {
  id                String        @id @default(uuid())
  memberId          String
  staffId           String?
  staffName         String
  faculty           String?
  fundingLocation   String        // 'IN_UTAR' or 'NOT_IN_UTAR'
  fundingBody       String
  projectStatus     String
  role              String        // 'PRINCIPAL INVESTIGATOR' or 'CO-RESEARCHER'
  title             String
  objective         String?
  projectDuration   String?
  commencementDate  String?
  endDate           String?
  fundingAmount     Decimal       @db.Decimal(15, 2)
  grantType         String        // 'INTERNAL' or 'EXTERNAL'
  grantCategory     String?       // 'INTERNATIONAL' or 'NATIONAL' (for external grants)
  projectNumber     String?
  researchArea      String?
  researchCentre    String?
  keywords          String?       // JSON array
  collaborators     String?       // JSON array
  institutionParked String?       // For NOT_IN_UTAR grants
  createdAt         DateTime      @default(now())
  member            RCGrantMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([fundingLocation])
  @@index([grantType])
  @@index([role])
  @@index([commencementDate])
  @@map("grants")
}

enum UserRole {
  student
  member
  chairperson
  public
}

enum AccessLevel {
  student
  member
  chairperson
  public
}

model DocumentLibraryEntry {
  id            String   @id @default(uuid())
  documentTitle String?  @map("document_title")  // Parent document title
  title         String                            // Section title
  content       String
  department    String?
  documentType  String?  @map("document_type")
  tags          String[] @default([])
  priority      String   @default("standard")
  accessLevel   String[] @default(["student", "member", "chairperson"]) @map("access_level")
  status        String   @default("active")
  isActive      Boolean  @default(true) @map("is_active")
  sourceFile    String?  @map("source_file")
  sectionIndex  Int?     @map("section_index")
  metadata      Json?
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  creator       User     @relation("DocumentLibraryEntries", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([createdBy])
  @@index([priority])
  @@index([department])
  @@index([documentType])
  @@index([sourceFile])
  @@index([documentTitle])
  @@map("document_library_entries")
}

model DocumentLibraryBatch {
  id             String    @id @default(uuid())
  batchName      String    @map("batch_name")
  totalDocuments Int       @default(0) @map("total_documents")
  totalSections  Int       @default(0) @map("total_sections")
  importedCount  Int       @default(0) @map("imported_count")
  skippedCount   Int       @default(0) @map("skipped_count")
  errorCount     Int       @default(0) @map("error_count")
  status         String    @default("processing")
  importLog      Json?     @map("import_log")
  createdBy      String    @map("created_by")
  createdAt      DateTime  @default(now()) @map("created_at")
  completedAt    DateTime? @map("completed_at")
  creator        User      @relation("DocumentLibraryBatches", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([status])
  @@index([createdAt])
  @@map("document_library_batches")
}
